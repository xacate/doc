<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marb - Android</title>
    <link rel="manifest" href="/manifest.json">
    <script src="/registerServiceWorker.js" module></script>
</head>
<style>
    body,
    html {
        margin: 0;
    }

    body {
        position: relative;
    }

    .flex-row {
        display: flex;
        flex-direction: row;
    }

    .flex-column {
        display: flex;
        flex-direction: column;
    }

    .flex-center {
        align-items: center;
        justify-content: center;
    }

    .g {
        aspect-ratio: 8.1;
    }
</style>

<body>
    <div id="install-container" class="hidden">
        <div class="install-progress">
          <div class="progress-bar"></div>
        </div>
        <div class="status-text">準備安裝...</div>
        <button id="cancel-install" class="btn">取消</button>
      </div>
    <div class="flex-row flex-center" style="width: 100%;">
        <div class="flex-column flex-center" style="position: relative;max-width: 750px;">
            <img style="object-fit: cover;width: 100%;" src="./img/android.png" alt="">
            <div class="g"
                style="position: absolute;width: 90.5%;background-color: #ff000000;z-index: 10;top: 13%;left: 4.5%;"
                onclick="downloadClick()">
            </div>
        </div>
        <script>
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });
            function downloadClick() {
                if (!deferredPrompt) {
                    return;
                }
                if (deferredPrompt == undefined) {
                    return;
                }
                deferredPrompt.prompt();
                // 监听实际安装完成事件
                window.addEventListener('appinstalled', () => {
                    console.log('PWA 已成功安装到设备');
                    // 这里执行安装成功后的操作
                    trackInstallationSuccess();
                });
                deferredPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        window.alert('MARB installed.');
                    } else {
                        console.log('User cancelled home screen install.');
                    }
                    // deferredPrompt = null; // 重置提示变量。
                });
            }

            // 安装成功跟踪函数
            function trackInstallationSuccess() {
                // 验证是否已安装
                if (window.matchMedia('(display-mode: standalone)').matches) {

                }
            }
        </script>
        <script>
            // JavaScript 邏輯
            class PWAInstaller {
                constructor() {
                    this.deferredPrompt = null;
                    this.installState = 'idle'; // 狀態機: idle|preparing|installing|done|error
                    this.progress = 0;
                    this.timeoutId = null;

                    this.initEvents();
                }

                initEvents() {
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.deferredPrompt = e;
                        this.showInstallButton(); // 顯示安裝按鈕
                    });

                    window.addEventListener('appinstalled', () => {
                        this.handleInstallSuccess();
                    });

                    document.getElementById('cancel-install').addEventListener('click', () => {
                        this.cancelInstall();
                    });
                }

                async startInstall() {
                    try {
                        this.updateUI('preparing', 0);

                        // 觸發安裝提示
                        this.deferredPrompt.prompt();

                        // 等待用戶選擇
                        const { outcome } = await this.deferredPrompt.userChoice;

                        if (outcome === 'accepted') {
                            this.updateUI('installing', 30);
                            this.monitorInstallation();
                        } else {
                            this.updateUI('error', 0, '安裝已取消');
                        }
                    } catch (error) {
                        this.updateUI('error', 0, `安裝失敗: ${error.message}`);
                    }
                }

                monitorInstallation() {
                    // 啟動假進度動畫
                    this.animateProgress(30, 80, 2000);

                    // 設定安裝超時檢查
                    this.timeoutId = setTimeout(() => {
                        if (this.checkInstalledStatus()) {
                            this.handleInstallSuccess();
                        } else {
                            this.updateUI('error', 0, '安裝超時');
                        }
                    }, 10000); // 10秒超時
                }

                handleInstallSuccess() {
                    clearTimeout(this.timeoutId);
                    this.updateUI('done', 100);
                    setTimeout(() => this.hideUI(), 2000);
                }

                animateProgress(start, end, duration) {
                    let startTime = null;

                    const step = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const progress = Math.min((timestamp - startTime) / duration, 1);
                        const currentProgress = start + (end - start) * progress;

                        this.updateUI('installing', currentProgress);

                        if (progress < 1) {
                            requestAnimationFrame(step);
                        }
                    };

                    requestAnimationFrame(step);
                }

                checkInstalledStatus() {
                    return window.matchMedia('(display-mode: standalone)').matches;
                }

                updateUI(state, progress, message) {
                    this.installState = state;
                    this.progress = progress;

                    const container = document.getElementById('install-container');
                    const progressBar = container.querySelector('.progress-bar');
                    const statusText = container.querySelector('.status-text');

                    // 更新進度條
                    progressBar.style.width = `${progress}%`;

                    // 更新狀態文字
                    const statusMessages = {
                        preparing: '準備安裝中...',
                        installing: '正在安裝...',
                        done: '安裝完成!',
                        error: message || '發生錯誤'
                    };
                    statusText.textContent = statusMessages[state];

                    // 顯示/隱藏容器
                    if (state === 'idle') {
                        container.classList.add('hidden');
                    } else {
                        container.classList.remove('hidden');
                    }
                }

                cancelInstall() {
                    clearTimeout(this.timeoutId);
                    this.updateUI('idle', 0);
                }

                showInstallButton() {
                    // 顯示自定義安裝按鈕邏輯
                }

                hideUI() {
                    this.updateUI('idle', 0);
                }
            }

            // 初始化安裝器
            const installer = new PWAInstaller();
        </script>
</body>

</html>